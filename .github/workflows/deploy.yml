name: CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create Angular environment files
        run: |
          mkdir -p src/environments
          cat > src/environments/environment.production.ts << EOL
          export const environment = {
            production: true,
            apiUrl: '${{ secrets.API_URL || 'http://localhost:8000' }}',
          };
          EOL

      - name: Build
        run: npm run build

      - name: Test
        run: npm run test:ci

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Deploy to Raspberry Pi
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.RASPBERRY_PI_HOST }}
          username: ${{ secrets.RASPBERRY_PI_USERNAME }}
          key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
          passphrase: ${{ secrets.RASPBERRY_PI_SSH_PASSPHRASE || '' }}
          script: |
            cd ~/cockpit-app
            git pull origin master
            docker compose down
            docker compose up -d --build
