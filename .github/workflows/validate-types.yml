name: Validate API Types

on:
  workflow_call:
    inputs:
      create-pr-on-drift:
        description: 'Create PR if types drift is detected'
        required: false
        default: false
        type: boolean
      force-update-types:
        description: 'Force update types even if no drift detected'
        required: false
        default: false
        type: boolean
    outputs:
      drift-detected:
        description: 'Whether API drift was detected'
        value: ${{ jobs.validate-types.outputs.drift-detected }}
      validation-status:
        description: 'Overall validation status'
        value: ${{ jobs.validate-types.outputs.validation-status }}

jobs:
  validate-types:
    runs-on: ubuntu-latest
    name: Validate API Types
    outputs:
      drift-detected: ${{ steps.drift-check.outputs.drift-detected }}
      validation-status: ${{ steps.validation-summary.outputs.status }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for API Types Drift
        id: drift-check
        run: |
          echo "Checking for OpenAPI specification changes..."
          set +e
          npm run check:drift
          drift_status=$?
          set -e

          echo "drift-status=${drift_status}" >> $GITHUB_OUTPUT
          if [ $drift_status -eq 0 ]; then
            echo "drift-detected=false" >> $GITHUB_OUTPUT
            echo "✅ No API drift detected"
          else
            echo "drift-detected=true" >> $GITHUB_OUTPUT
            echo "⚠️ API drift detected"
          fi

      - name: Force Update Types
        if: inputs.force-update-types == true
        run: |
          echo "🔄 Force updating types..."
          npm run generate:types:force
          npm run build:types

      - name: Update Types if Drift Detected
        if: steps.drift-check.outputs.drift-detected == 'true' && inputs.force-update-types == false
        run: |
          echo "🔄 API drift detected - updating types..."
          npm run generate:types:force
          npm run build:types

      - name: Create PR for Type Updates
        if: steps.drift-check.outputs.drift-detected == 'true' && inputs.create-pr-on-drift == true
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: '🤖 Auto-update API types due to drift detection'
          title: '🤖 Automated API Types Update'
          body: |
            ## 🔄 Automated Type Update

            OpenAPI specification drift was detected during validation.

            ### Changes Made:
            - ✅ Generated fresh types from API specification
            - ✅ Updated all 11 type libraries
            - ✅ Verified type coverage and compilation

            ### Validation Results:
            - **Drift Check**: Changes detected in OpenAPI spec
            - **Type Coverage**: All libraries validated
            - **Compilation**: All types compile successfully

            This PR was automatically created to keep types in sync with the API.

            ### Next Steps:
            1. Review the generated type changes
            2. Test the updated types in development
            3. Merge when ready to deploy

            ---
            *Generated by automated workflow on ${{ github.event_name }} trigger*
          branch: automated/api-types-update-${{ github.run_id }}
          delete-branch: true

      - name: Verify Type Coverage and Integrity
        run: |
          echo "📊 Verifying type coverage across all libraries..."
          npm run verify:types

      - name: Run Type Generation Tests
        run: |
          echo "🧪 Testing type generation system..."
          npm run test:types

      - name: Validate Type Compilation
        run: |
          echo "🔨 Ensuring all type libraries compile successfully..."
          npm run build:types

      - name: Validation Summary
        id: validation-summary
        run: |
          echo "✅ Type validation completed successfully"
          echo "📊 Libraries validated: 11"
          echo "🔄 Generation system tested"
          echo "📝 Coverage verified"
          echo "🔨 All libraries compiled"
          echo ""

          if [ "${{ steps.drift-check.outputs.drift-detected }}" == "true" ]; then
            echo "⚠️ API drift was detected and types were updated"
            echo "status=updated" >> $GITHUB_OUTPUT
          else
            echo "✅ No drift detected - types are current"
            echo "status=current" >> $GITHUB_OUTPUT
          fi
